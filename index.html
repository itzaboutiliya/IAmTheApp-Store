<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ImTheApp Store</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f9f9f9; color: #222; }
    header { text-align: center; margin-bottom: 20px; }
    header img { height: 60px; vertical-align: middle; }
    header h1 { display: inline-block; margin-left: 10px; vertical-align: middle; }
    #langSelect { margin-top: 10px; }
    .tabs { margin-bottom: 10px; text-align: center; }
    .tab-button {
      background: #007aff; color: white; border: none; padding: 10px 15px; margin: 0 3px; cursor: pointer;
      border-radius: 4px;
    }
    .tab-button.active { background: #004bb5; }
    #searchInput {
      width: 90%; max-width: 400px; padding: 8px; margin: 10px auto; display: block; border-radius: 5px; border: 1px solid #ccc;
    }
    #appList { max-width: 600px; margin: 0 auto; }
    .app-item {
      background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex; align-items: center;
    }
    .app-icon { width: 60px; height: 60px; border-radius: 12px; background: #ddd; flex-shrink: 0; }
    .app-info { flex-grow: 1; margin-left: 12px; }
    .app-name { font-size: 18px; margin: 0; }
    .app-source { font-size: 12px; color: #555; margin: 3px 0 0 0; }
    .install-button {
      background: #28a745; border: none; color: white; padding: 8px 14px; border-radius: 5px; cursor: pointer;
      flex-shrink: 0;
    }
    .install-button:hover { background: #218838; }
  </style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/fT8yVv7W/1754473252110.png" alt="ImTheApp Store Logo" />
  <h1 id="title">ImTheApp Store</h1><br/>
  <select id="langSelect" aria-label="Language select">
    <option value="en">English</option>
    <option value="fa">فارسی</option>
  </select>
</header>

<div class="tabs">
  <button class="tab-button active" data-version="6">iOS 6</button>
  <button class="tab-button" data-version="7-8">iOS 7 & 8</button>
  <button class="tab-button" data-version="9">iOS 9</button>
</div>

<input type="search" id="searchInput" placeholder="Search apps..." aria-label="Search apps" />

<div id="appList">Loading...</div>

<script>
  var appsUrl = 'apps.json'; // your merged JSON file
  var appsData = [];
  var currentVersion = '6';
  var currentLang = 'en';

  var tabs = document.getElementsByClassName('tab-button');
  var appList = document.getElementById('appList');
  var searchInput = document.getElementById('searchInput');
  var langSelect = document.getElementById('langSelect');

  function loadApps() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', appsUrl + '?nocache=' + new Date().getTime(), true); // prevent cache
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            appsData = JSON.parse(xhr.responseText);
            renderApps();
          } catch (e) {
            appList.innerHTML = '<p style="color:red;text-align:center;">⚠️ Error parsing app data</p>';
          }
        } else {
          appList.innerHTML = '<p style="color:red;text-align:center;">⚠️ Failed to load apps data</p>';
        }
      }
    };
    xhr.send();
  }

  function getIcon(app) {
    // if JSON already has icon
    if (app.icon && app.icon.indexOf('placeholder') === -1) return app.icon;
    // fallback to DuckDuckGo image proxy (lightweight)
    var q = encodeURIComponent(app.name_en + " app icon");
    return "https://duckduckgo.com/i/favicons/raw/" + q + ".ico";
  }

  function renderApps() {
    var searchTerm = searchInput.value.toLowerCase();
    appList.innerHTML = '';
    var filtered = [];

    for (var i = 0; i < appsData.length; i++) {
      var app = appsData[i];
      var check = false;
      if (currentVersion === '7-8') {
        if (app.ios_version === '7' || app.ios_version === '8') check = true;
      } else {
        if (app.ios_version === currentVersion) check = true;
      }
      if (check) {
        var name = (currentLang === 'en') ? app.name_en : app.name_fa;
        if (name.toLowerCase().indexOf(searchTerm) !== -1) filtered.push(app);
      }
    }

    if (filtered.length === 0) {
      appList.innerHTML = '<p style="text-align:center; color:#888;">' +
        (currentLang === 'fa' ? 'برنامه‌ای یافت نشد' : 'No apps found') + '</p>';
      return;
    }

    for (var j = 0; j < filtered.length; j++) {
      var app = filtered[j];
      var appDiv = document.createElement('div');
      appDiv.className = 'app-item';

      var icon = document.createElement('img');
      icon.src = getIcon(app);
      icon.alt = app.name_en + ' icon';
      icon.className = 'app-icon';
      appDiv.appendChild(icon);

      var info = document.createElement('div');
      info.className = 'app-info';

      var nameEl = document.createElement('p');
      nameEl.className = 'app-name';
      nameEl.innerHTML = (currentLang === 'en') ? app.name_en : app.name_fa;
      info.appendChild(nameEl);

      var source = document.createElement('p');
      source.className = 'app-source';
      source.innerHTML = (currentLang === 'fa' ? 'منبع: ' : 'Source: ') + app.source;
      info.appendChild(source);

      appDiv.appendChild(info);

      var btn = document.createElement('button');
      btn.className = 'install-button';
      btn.innerHTML = (currentLang === 'en') ? 'Install' : 'نصب';
      btn.onclick = (function(url) {
        return function() { window.location.href = url; };
      })(app.install_url);
      appDiv.appendChild(btn);

      appList.appendChild(appDiv);
    }
  }

  for (var k = 0; k < tabs.length; k++) {
    tabs[k].onclick = (function(tab) {
      return function() {
        for (var t = 0; t < tabs.length; t++) tabs[t].className = tabs[t].className.replace(' active', '');
        tab.className += ' active';
        currentVersion = tab.getAttribute('data-version');
        renderApps();
      };
    })(tabs[k]);
  }

  searchInput.onkeyup = renderApps;

  langSelect.onchange = function() {
    currentLang = langSelect.value;
    document.body.dir = (currentLang === 'fa') ? 'rtl' : 'ltr';
    document.getElementById('title').innerHTML =
      (currentLang === 'fa' ? 'فروشگاه ImTheApp' : 'ImTheApp Store');
    renderApps();
  };

  loadApps();
</script>

</body>
</html>
